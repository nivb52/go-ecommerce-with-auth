# LINUX
SHELL=bash
GOSTRIPE_PORT=4000
API_PORT=4001
DSN="root@(localhost:3306)/widgets?parseTime=true&tls=false"
air="$(HOME)/go/bin/air"

## build: builds all binaries
build: clean build_front build_back
	@echo "All binaries built!"

## clean: cleans all binaries and runs go clean
clean:
	@echo "Cleaning..."
	@- rm -f dist/*
	@go clean
	@echo "Cleaned and deleted binaries"

## watch_front: Watch the front end
watch_front:
	go build -o ./tmp/web/main ./cmd/web/
	@echo "Set permission to ./tmp/web/main"
	@chmod +x ./tmp/web/main
	@echo "Watch front end..."
	@$(air) -c ./web.air.toml
	@echo "Front end built!"
dev_front: watch_front
dev front: watch_front

## watch_back: Watch the back end
watch_back:
	go build -o ./tmp/api/main ./cmd/api/
	@echo "Set permission to ./tmp/api/main"
	@chmod +x ./tmp/api/main
	@echo "Watch back end..."
	@$(air) -c ./api.air.toml
	@echo "Back end built!"
dev_back: watch_back
dev back: watch_back

## dev: starts watching files of front (web) and back end
dev : dev_front dev_back
serve : watch_front watch_back

## build_front: builds the front end
build_front:
	@echo "Building front end..."
	@go build -o dist/gostripe ./cmd/web
	@echo "Front end built!"

## build_back: builds the back end
build_back:
	@echo "Building back end..."
	@go build -o dist/gostripe_api ./cmd/api
	@echo "Back end built!"

## start: starts front and back end
start : start_front start_back

## start_front: starts the front end
start_front: build_front
	@echo "Starting the front end..."
	./dist/gostripe --port=${GOSTRIPE_PORT}
	@echo "Front end running!"

## start_back: starts the back end
start_back: build_back
	@echo "Starting the back end..."
	./dist/gostripe_api --port=${API_PORT}
	@echo "Back end running!"

## stop: stops the front and back end
stop: stop_front stop_back
	@echo "All applications stopped"

## stop_front: stops the front end
stop_front:
	@echo "Stopping the front end..."
	@-pkill -SIGTREM -f "gostripe --port ${GOSTRIPE_PORT}"
	@echo "Stopped front end"

## stop_back: stops the back end
stop_back:
	@echo "Stopping the back end..."
	@-pkill -SIGTREM -f "gostripe_api --port ${API_PORT}"
	@echo "Stopped back end"